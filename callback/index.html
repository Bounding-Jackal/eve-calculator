<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EVE Auth — Authenticating...</title>
<style>
  body {
    background: #050d1a;
    font-family: 'Courier New', Courier, monospace;
    color: #c8d8e8;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    margin: 0;
  }
  .box {
    text-align: center;
    border: 1px solid #1e3a5f;
    padding: 40px 60px;
    background: #07111f;
    max-width: 420px;
  }
  .title { font-size: 13px; letter-spacing: 4px; color: #3a7bd5; margin-bottom: 12px; }
  .msg   { font-size: 11px; color: #4a7a9b; margin-top: 8px; }
  .err   { color: #e74c3c; font-size: 11px; margin-top: 12px; }
  @keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
  .spin { display:inline-block; animation: spin 1.2s linear infinite; font-size:22px; color:#3a7bd5; }
</style>
</head>
<body>
<div class="box">
  <div class="title">EVE ONLINE SSO</div>
  <div class="spin">◈</div>
  <div class="msg" id="msg">Authenticating with EVE Online...</div>
  <div class="err" id="err"></div>
</div>

<script>
const CLIENT_ID    = "4c0d01552819491884073fb9dbf138ab";
const REDIRECT_URI = "https://bounding-jackal.github.io/eve-calculator/callback";

async function handleCallback() {
  const params = new URLSearchParams(window.location.search);
  const code   = params.get("code");
  const state  = params.get("state");
  const saved  = sessionStorage.getItem("eve_oauth_state");

  if (!code) {
    document.getElementById("err").textContent = "No auth code received from EVE SSO.";
    return;
  }
  if (state !== saved) {
    document.getElementById("err").textContent = "State mismatch — possible CSRF. Please try logging in again.";
    return;
  }

  document.getElementById("msg").textContent = "Exchanging auth code for token...";

  try {
    // Exchange code for token via EVE SSO
    const tokenRes = await fetch("https://login.eveonline.com/v2/oauth/token", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: new URLSearchParams({
        grant_type:   "authorization_code",
        code,
        redirect_uri: REDIRECT_URI,
        client_id:    CLIENT_ID,
      }),
    });

    if (!tokenRes.ok) {
      const err = await tokenRes.text();
      throw new Error(`Token exchange failed: ${tokenRes.status} — ${err}`);
    }

    const tokenData = await tokenRes.json();
    const accessToken = tokenData.access_token;

    document.getElementById("msg").textContent = "Fetching character info...";

    // Decode the JWT to get character info (no signature verification needed client-side)
    const payload = JSON.parse(atob(accessToken.split(".")[1].replace(/-/g,"+").replace(/_/g,"/")));
    const charId  = payload.sub.replace("CHARACTER:EVE:", "");
    const charName = payload.name;

    // Store in sessionStorage for the main app
    sessionStorage.setItem("eve_token", accessToken);
    sessionStorage.setItem("eve_character", JSON.stringify({
      CharacterID:   parseInt(charId),
      CharacterName: charName,
    }));
    sessionStorage.removeItem("eve_oauth_state");

    document.getElementById("msg").textContent = `Welcome, ${charName}! Redirecting...`;

    setTimeout(() => {
      window.location.href = "https://bounding-jackal.github.io/eve-calculator/";
    }, 800);

  } catch(e) {
    document.getElementById("msg").textContent = "Authentication failed.";
    document.getElementById("err").textContent = e.message;
    console.error(e);
  }
}

handleCallback();
</script>
</body>
</html>
